
# improvement:
# * add keywords for the autocompletion: tags, title, description, properties
# * add pipelines for the autocompletion: |fromParmeters, |fromGlossary...
# * fix color syntax
# * fix snippet autocompletion
# * handle common errors : yaml syntax, nunjucks syntax, svg syntax
#   * display errors : "Map keys must be unique; "ğŸ´cityCard" is repeated"
# * implement the goto ğŸ“definition


ğŸ´cityCard:
  title: city card
  description:
  tags: ğŸ’ abstract
  properties: âœ…provide ğŸš®discard ğŸ—ï¸build

ğŸ¤quantity:
  tags: ğŸ’ abstract
  description: |
    it describe quantity  of something
    
    ğŸ’–ğŸ¤ğŸ§¡ğŸ’›ğŸ’šğŸ’™ğŸ’œğŸ¤ğŸ–¤

ğŸ“¦byGame:
  title: by game
  description: ğŸ¤quantity defined by game

ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer:
  title: by player
  description: ğŸ¤quantity defined by player

ğŸ’–unique:
  tags: ğŸ¤quantity  
  description: 1 instance

ğŸ’œexceptionnel:
  tags: ğŸ¤quantity
  description: 2 instances

ğŸ§¡rare:
  description: 4 instances

ğŸ’›common:
  description: 8 instances

ğŸ¤plain:
  description: 16 instances

## Slots

ğŸ›ï¸bank:
  description: reserve of unplayed items

ğŸƒtrash:
  description: trash of player

ğŸƒcityStack:
  description: deck of player

ğŸ–ï¸hand:
  description: playable ğŸ´cityCard of the player


## Money

ğŸ’°money:
  tags: ğŸ’ abstract
  description: |

      > 1ğŸ˜ƒhappiness + 1ğŸ˜¡anger = 0ğŸ’°money 

ğŸ˜ƒhappiness:
  tags: ğŸ´cityCard ğŸ’°money ğŸ¤plain ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer
  description: |
    You can use ğŸ˜ƒhappiness from your ğŸ–ï¸hand to buy something.
    but you have to discard in the ğŸ›ï¸bank.

ğŸ˜¡anger:
  tags: ğŸ´cityCard ğŸ’°money ğŸ¤plain ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer
  description: |
    You can get unlimited ğŸ˜¡anger from the ğŸ›ï¸bank to buy something.
    but you have to add this in your ğŸƒtrash.

    in order to clear your ğŸ˜¡anger, you can settle during your turn:

    * discard 1ğŸ˜¡anger and 1ğŸ˜ƒhappiness from your ğŸ–ï¸hand to the ğŸ›ï¸bank

## Side Effects

ğŸ’¢painfullCard:
  title: painful card
  tags: ğŸ’ abstract
  description: |
    how to use it for each case?

    * ğŸ—ï¸build & âœ…provide: transfert ğŸ’¢painfullCard from the ğŸ›ï¸bank to your ğŸƒtrash
    * ğŸš®discard: transfert ğŸ’¢painfullCard from your ğŸ–ï¸hand to the ğŸ›ï¸bank if you have!

    > in another word, you can't use your ğŸ’¢painfullCard in your ğŸ–ï¸hand to ğŸ—ï¸build something

ğŸŒ«ï¸pollution:
  tags: ğŸ´cityCard ğŸ’¢painfullCard ğŸ’›common ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer

ğŸš¦jumpTraffic:
  title: jump traffic
  tags: ğŸ´cityCard ğŸ’¢painfullCard ğŸ’›common ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer
  description: |
    you can convert 3ğŸš¦jumpTraffic to 1ğŸŒ«ï¸pollution

ğŸ’¸crime:
  tags: ğŸ´cityCard ğŸ’¢painfullCard ğŸ’›common ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer
  description: petty & serouis & white-collar crime
  âœ…provide: ğŸ˜¡anger

## Ressources

ğŸ›£ï¸move:
  description: take one ğŸ´cityCard from your ğŸƒcityStack to your ğŸ–ï¸hand.

ğŸ™ï¸activity:
  description: resolve on card in your hands and discard in your ğŸƒtrash.
  tags: ğŸ’ abstract

## Indicators

âœ…provide:
  description: income when the card is actived 

ğŸš®discard:
  description: outcome when the card is actived

ğŸ—ï¸build:
  description: outcome when the card is built

ğŸ“‘for:
  description: usable only for

## ğŸ™ï¸activity

ğŸ­industry:
  tags: ğŸ´cityCard ğŸ’œexceptionnel ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer
  âœ…provide: 2ğŸŒ«ï¸pollution 3ğŸ™ï¸activity
  ğŸš®discard: 1ğŸ™ï¸activity 
  ğŸ—ï¸build: 5ğŸ’°money

ğŸ¢skyscraper:
  tags: ğŸ´cityCard ğŸ’œexceptionnel ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer
  âœ…provide: 3ğŸ™ï¸activity 1ğŸ’¸crime
  ğŸš®discard: 1ğŸ™ï¸activity
  ğŸ—ï¸build: 5ğŸ’°money

ğŸªshop: {}

## education

ğŸ«school: {}
ğŸ‘®police: {}
âš–ï¸justice: {}

## hobbies

â›²square:
  tags: ğŸ´cityCard ğŸ§¡rare ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer
  âœ…provide: ğŸ˜ƒhappiness
  ğŸš®discard: 1ğŸ™ï¸activity

ğŸ­theatre: {}
ğŸ carouselHorse: {}
ğŸ¡ FerrisWheel: {}

## Transports

ğŸš—car:
  tags: ğŸ´cityCard ğŸ’›common ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer
  âœ…provide: 3ğŸ›£ï¸move 1ğŸš¦jumpTraffic 1ğŸŒ«ï¸pollution 1ğŸ—ºï¸transportCard 
  ğŸ—ï¸build: 2ğŸ’°money
  ğŸš®discard: 1ğŸ™ï¸activity

ğŸš´â€â™‚ï¸bike:
  tags: ğŸ´cityCard ğŸ’›common ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer
  âœ…provide: 1ğŸ›£ï¸move 1ğŸ™ï¸activity 1ğŸ—ºï¸transportCard
  ğŸš®discard: 1ğŸ™ï¸activity 1ğŸš¦jumpTraffic 
  ğŸ—ï¸build: 2ğŸš¦jumpTraffic

â“‚ï¸metro:
  tags: ğŸ´cityCard ğŸ’›common ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer
  âœ…provide: 1ğŸ›£ï¸move 1ğŸ—ºï¸transportCard
  ğŸš®discard: 1ğŸ™ï¸activity 2ğŸš¦jumpTraffic 
  ğŸ—ï¸build: 5ğŸ’°money 5ğŸš¦jumpTraffic

### Transport Event

ğŸ—ºï¸transportStack:
  title: transport Stack
  tags: ğŸƒeventStack

ğŸ—ºï¸transportCard:
  title: transport
  tags: âš¡event

ğŸ› ï¸MetroUpkeep:
  title: Metro Upkeep
  tags: ğŸ—ºï¸transportCard ğŸ’–unique ğŸ“¦byGame
  âœ…provide: 1ğŸš¦jumpTraffic
  ğŸ“‘for: â“‚ï¸metro

ğŸ› ï¸bikeUpkeep:
  title: bike Upkeep
  tags: ğŸ—ºï¸transportCard ğŸ’–unique ğŸ“¦byGame
  âœ…provide: 1ğŸ˜¡anger
  ğŸ“‘for: ğŸš´â€â™‚ï¸bike

ğŸ› ï¸carUpkeep1:
  title: car Upkeep
  tags: ğŸ—ºï¸transportCard ğŸ’–unique ğŸ“¦byGame
  âœ…provide: 1ğŸ˜¡anger
  ğŸ“‘for: ğŸš—car

ğŸ› ï¸carUpkeep2:
  title: car Upkeep
  tags: ğŸ—ºï¸transportCard ğŸ’–unique ğŸ“¦byGame
  âœ…provide: 2ğŸ˜¡anger
  ğŸ“‘for: ğŸš—car

ğŸŒsunlight:
  tags: ğŸ—ºï¸transportCard ğŸ’–unique ğŸ“¦byGame
  âœ…provide: 1ğŸ˜ƒhappiness
  ğŸ“‘for: ğŸš´â€â™‚ï¸bike

ğŸŒ§ï¸rain:
  tags: ğŸ—ºï¸transportCard ğŸ’–unique ğŸ“¦byGame
  âœ…provide: 1ğŸ˜¡anger
  ğŸ“‘for: ğŸš´â€â™‚ï¸bike

### Engine

âš¡event:
  tags: ğŸƒcard

ğŸƒeventStack: 
  description: |
    it is lottery of events happened when you use something:

    * shuffle **all** âš¡event
    * get and resolve immediately the âš¡event.

  tags: ğŸƒstack


######################################
## printing

â¹myLayout:
  tags: â¹layout
  ğŸ“„format: ğŸƒpoker 
  ğŸ”„orientation: ğŸ”„portrait
  ğŸ“paddings: 4ğŸ“mm
  ğŸ“bleeds: 0ğŸ“mm
  ğŸ“corners: 4ğŸ“mm

ğŸ–¼ï¸theTransportDeck:
  tags: ğŸ–¼ï¸collection 
  ğŸ“‘foreach:
    - { ğŸ“‘among: ğŸ—ºï¸transportCard, ğŸ–¨ï¸copies: 1, ğŸ´back: ğŸ—ºï¸transportCard}
  â¹layout: â¹myLayout
  ğŸ“template: ğŸ“myGenericTemplate
  ğŸ“parameters:
    â¬›left: ğŸš®discard
    â¬›right: âœ…provide
    â¬›bottom: ğŸ—ï¸build
    â¬›header: ğŸ“‘for

ğŸ–¼ï¸theDeckByPlayer:
  tags: ğŸ–¼ï¸collection 
  ğŸ“‘foreach:
    - { ğŸ“‘among: ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer, ğŸ“‘with: ğŸ´cityCard ğŸ’–unique, ğŸ–¨ï¸copies: 1, ğŸ´back: ğŸ cityBuilder}
    - { ğŸ“‘among: ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer, ğŸ“‘with: ğŸ´cityCard ğŸ’œexceptionnel, ğŸ–¨ï¸copies: 2, ğŸ´back: ğŸ cityBuilder}
    - { ğŸ“‘among: ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer, ğŸ“‘with: ğŸ´cityCard ğŸ§¡rare, ğŸ–¨ï¸copies: 4, ğŸ´back: ğŸ cityBuilder}
    - { ğŸ“‘among: ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer, ğŸ“‘with: ğŸ´cityCard ğŸ’›common,  ğŸ–¨ï¸copies: 8, ğŸ´back: ğŸ cityBuilder}
    - { ğŸ“‘among: ğŸ§‘â€ğŸ¤â€ğŸ§‘byPlayer, ğŸ“‘with: ğŸ´cityCard ğŸ¤plain, ğŸ–¨ï¸copies: 16, ğŸ´back: ğŸ cityBuilder}
  â¹layout: â¹myLayout
  ğŸ“template: ğŸ“myGenericTemplate
  ğŸ“parameters:
    â¬›left: ğŸš®discard
    â¬›right: âœ…provide
    â¬›bottom: ğŸ—ï¸build
    â¬›header: ğŸ“‘for

ğŸ–¼ï¸theDeckByGame:
  tags: ğŸ–¼ï¸collection 
  ğŸ“‘foreach:
    - { ğŸ“‘among: ğŸ“¦byGame, ğŸ“‘with: ğŸ´cityCard ğŸ’–unique, ğŸ–¨ï¸copies: 1, ğŸ´back: ğŸ cityBuilder}
    - { ğŸ“‘among: ğŸ“¦byGame, ğŸ“‘with: ğŸ´cityCard ğŸ’œexceptionnel, ğŸ–¨ï¸copies: 2, ğŸ´back: ğŸ cityBuilder}
    - { ğŸ“‘among: ğŸ“¦byGame, ğŸ“‘with: ğŸ´cityCard ğŸ§¡rare, ğŸ–¨ï¸copies: 4, ğŸ´back: ğŸ cityBuilder}
    - { ğŸ“‘among: ğŸ“¦byGame, ğŸ“‘with: ğŸ´cityCard ğŸ’›common,  ğŸ–¨ï¸copies: 8, ğŸ´back: ğŸ cityBuilder}
    - { ğŸ“‘among: ğŸ“¦byGame, ğŸ“‘with: ğŸ´cityCard ğŸ¤plain, ğŸ–¨ï¸copies: 16, ğŸ´back: ğŸ cityBuilder}
  â¹layout: â¹myLayout
  ğŸ“template: ğŸ“myGenericTemplate
  ğŸ“parameters:
    â¬›left: ğŸš®discard
    â¬›right: âœ…provide
    â¬›bottom: ğŸ—ï¸build
    â¬›header: ğŸ“‘for

ğŸ›‘ReviewPrint: 
  tags: ğŸ–¨ï¸printing
  ğŸ“‘foreach:
    - { ğŸ“‘is: ğŸ–¼ï¸theTransportDeck }
    - { ğŸ“‘is: ğŸ–¼ï¸theDeckByGame  }
    - { ğŸ“‘is: ğŸ–¼ï¸theDeckByPlayer }
  ğŸ–¨ï¸mode: ğŸ›‘review
  ğŸ“density: 300ğŸ“dpi
  ğŸ“margins: 0ğŸ“mm  

ğŸ–¨ï¸StarterKitDIY:
  description: all cards to play for one
  tags: ğŸ–¨ï¸assembling
  ğŸ“‘foreach:
    - { ğŸ“‘is: ğŸ–¼ï¸theTransportDeck }
    - { ğŸ“‘is: ğŸ–¼ï¸theDeckByGame }
    - { ğŸ“‘is: ğŸ–¼ï¸theDeckByPlayer }
  ğŸ–¨ï¸mode: ğŸš€production
  ğŸ“„format: ğŸ“„A4
  â•marks: â•cross
  ğŸ”„orientation: ğŸ”„landscape
  ğŸ“margins: 15ğŸ“mm
  ğŸ“gutters: 0ğŸ“mm
  ğŸ“density: 300ğŸ“dpi  

ğŸ–¨ï¸BaseDIY:
  description: common cards for all players
  tags: ğŸ–¨ï¸assembling
  ğŸ“‘foreach:
    - { ğŸ“‘is: ğŸ–¼ï¸theTransportDeck }
    - { ğŸ“‘is: ğŸ–¼ï¸theDeckByGame }

  ğŸ–¨ï¸mode: ğŸš€production
  ğŸ“„format: ğŸ“„A4
  â•marks: â•cross
  ğŸ”„orientation: ğŸ”„landscape
  ğŸ“margins: 15ğŸ“mm
  ğŸ“gutters: 0ğŸ“mm
  ğŸ“density: 300ğŸ“dpi  

ğŸ–¨ï¸additionalPlayerDIY:
  description: all cards for additionnal player
  tags: ğŸ–¨ï¸assembling
  ğŸ“‘foreach:
    - { ğŸ“‘is: ğŸ–¼ï¸theDeckByPlayer }
  ğŸ–¨ï¸mode: ğŸš€production
  ğŸ“„format: ğŸ“„A4
  â•marks: â•cross
  ğŸ”„orientation: ğŸ”„landscape
  ğŸ“margins: 15ğŸ“mm
  ğŸ“gutters: 0ğŸ“mm 
  ğŸ“density: 300ğŸ“dpi 



########################################################################################

ğŸ²myTabletop:
  description: hello!

ğŸ“myTTSImport:
  tags: ğŸ“document
  ğŸ“template: ğŸ“ImportTTSScriptTemplate
  ğŸ“parameters:
    localUrl: 'file://d:/temp/deck-builder'
    baseUrl: 'https://raw.githubusercontent.com/marcgardent/tts-city-builder/version-01'
    ğŸ–¨ï¸printing: ğŸ›‘ReviewPrint

  ğŸ“‘foreach: { ğŸ“‘is: ğŸ²myTabletop }

ğŸ“¦myTTSBundle:
  tags: ğŸ“¦bundle
  ğŸ“¦filename: citybuilder-tts.zip
  ğŸ“‘foreach:
    - { ğŸ“‘is: ğŸ“myTTSImport }
    - { ğŸ“‘is: ğŸ›‘ReviewPrint }
    - { ğŸ“‘is: ğŸ–¨ï¸backPrinting }

########################################################################################
########################################################################################

ğŸ´back:
  description: |
    define the back card in the ğŸ“document ğŸ“‘request
    implemented only by ğŸ“ImportTTSScriptTemplate

ğŸ“ImportTTSScriptTemplate:
  tags: ğŸ“nunjucks
  ğŸ“extension: 'ttslua'
  ğŸ“definition: |
    
    {{ 'https://raw.githubusercontent.com/tjakubo2/Decker/master/Decker.ttslua' | includeAsText | safe }}
    -- The protoBG Code
    
    function deck(cardUrl, backUrl, quantity)
      local card = Decker.Card(Decker.Asset(cardUrl, backUrl))
      
      if quantity == 1 then
        return card
      else
        cards = {}    -- new array
        for i=1, quantity do
          table.insert(cards,card)
        end
        return Decker.Deck(cards)
      end
    end

    local decks = {}

    {% set baseUrl = 'baseUrl' | fromParameters %}
    {% set printing = 'ğŸ–¨ï¸printing' | fromParameters |fromGlossary %}
    {% set collections =  printing['ğŸ“‘foreach'] | request %}

    {% for collection in collections %}

    -- from {{ collection.result.name }}
      {% set cards = collection.result['ğŸ“‘foreach'] | request %}
      {% for card in cards %}
      {% set copies = card.request['ğŸ–¨ï¸copies'] %}
      {% set back = baseUrl + '/' + (card.request['ğŸ´back'] | fromGlossary).name + '.png' %}
      {% set front = baseUrl + '/' + card.result.name + '.png' %}
      table.insert(decks, deck('{{front}}', '{{back}}', {{copies}}))
      {% endfor %}
    {% endfor %}

    function mySpawn()
      for i,v in ipairs(decks) do
        v:spawn({position = {-30+(i*3), 5, 0}})
      end
    end
    
    function onChat(message,  sender)
      if message == 'go!' then
        mySpawn()
      end
    end

########################################################################################

ğŸ“backcardTemplate:
  tags: ğŸ“nunjucks
  ğŸ“extension: svg
  ğŸ“definition: |
    <svg xmlns="http://www.w3.org/2000/svg" 
    width="{{ width }}"
    height="{{ height }}" viewBox="0 0 {{ width }} {{ height }}" >
      <g id="bleedLayer" transform="translate({{bleedbox.x}}, {{bleedbox.y}})">
        <rect fill="lightgray" id="bleedbox" x="0" y="0" width="{{bleedbox.width}}" height="{{bleedbox.height}}"/>
      </g>
      <g id="trimLayer" transform="translate({{trimbox.x}}, {{trimbox.y}})">
        <rect id="trimbox" x="0" y="0" width="{{trimbox.width}}" height="{{trimbox.height}}"
            fill="lightgray" rx="{{trimbox.corners}}" ry="{{trimbox.corners}}"/>
      </g>
      <g id="artLayer" transform="translate({{artbox.x}}, {{artbox.y}})">
        <rect id="artbox" x="0" y="0" width="{{artbox.width}}" height="{{artbox.height}}"
        rx="{{trimbox.corners}}" ry="{{trimbox.corners}}" fill="black" />
        <text style="font-family: sans-serif;font-size:15" x="{{artbox.width/2}}" y="{{artbox.height/2}}" text-anchor="middle">
            {{ 'icon' | fromModel }}
        </text>
        <text style="font: small-caps bold 8px sans-serif" x="{{artbox.width/2}}" y="{{artbox.height/2+12}}" text-anchor="middle" fill="lightgray">
            {{ 'title' | fromModel }}
        </text>
      </g>
    </svg>

ğŸ cityBuilder:
  title: City Builder
  description: Deck builder

ğŸ–¼ï¸backCollection:
  tags: ğŸ–¼ï¸collection
  â¹layout: â¹myLayout
  ğŸ“template: ğŸ“backcardTemplate
  ğŸ“parameters: {}
  ğŸ“‘foreach:
    - { ğŸ“‘is: ğŸ cityBuilder}
    - { ğŸ“‘is: ğŸ—ºï¸transportCard}

ğŸ–¨ï¸backPrinting:
  tags: ğŸ–¨ï¸printing
  ğŸ“‘foreach:
    - { ğŸ“‘is: ğŸ–¼ï¸backCollection, ğŸ–¨ï¸copies: 10}
  ğŸ–¨ï¸mode: ğŸš€production
  ğŸ“margins: 0ğŸ“mm
  ğŸ“density: 300ğŸ“dpi

########################################################################################

########################################################################################





ğŸ“myGenericTemplate:
  tags: ğŸ“nunjucks 
  ğŸ“extension: 'svg'
  ğŸ“definition: |
    {% set content = {
      corners: trimbox.corners/2,
      cell: artbox.width/5,
      halfCell: artbox.width/5*0.5,
      quarterCell:artbox.width/5*0.25,
      threeQuarterCell:artbox.width/5*0.75,
      middleX: artbox.width/2, 
      middleY: artbox.height/2 
      }
    %}

    {% set left = {
        quantities: 'â¬›left' | fromParameters | fromModel |default([]) | arrayOfQuantities,
        action: 'â¬›left' | fromParameters | fromGlossary | default({icon:'â“'})
      }
    %}
    {% set right = {
        quantities: 'â¬›right' | fromParameters | fromModel |default([]) | arrayOfQuantities,
        action: 'â¬›right' | fromParameters | fromGlossary | default({icon:'â“'})
      }
    %}

    {% set bottom = {
        quantities: 'â¬›bottom' | fromParameters | fromModel |default([]) | arrayOfQuantities,
        action: 'â¬›bottom' | fromParameters | fromGlossary | default({icon:'â“'})
      }
    %}

    {% set header = {
        quantities: 'â¬›header' | fromParameters | fromModel |default([]) | arrayOfQuantities,
        action: 'â¬›header' | fromParameters | fromGlossary | default({icon:'â“'})
      }
    %}

    {% set footer = {
        quantities: 'â¬›footer' | fromParameters | fromModel |default([]) | arrayOfQuantities,
        action: 'â¬›footer' | fromParameters | fromGlossary | default({icon:'â“'})
      }
    %}

    {% macro badge(x,y, size, emoji) %}
      <rect class="badge"
      rx="{{size/2}}" ry="{{size/2}}"
      x="{{x-size/2}}" y="{{y-size/2}}" width="{{size}}" height="{{size}}"></rect>
      <text x="{{x}}" y="{{y}}" style="font-size:{{size*3}}%">
        {{emoji}}
      </text>
    {% endmacro %}

    {% macro vRibbon(name, x, y, data) %}
      {% if data.quantities.length  > 0 %}
        {% set ribbonSize = content.halfCell + data.quantities.length * content.halfCell %}
        <g id="{{name}}"  transform="translate({{x}}, {{y-ribbonSize/2}})">

          <rect class="ribbon vertical background" x="-{{content.halfCell}}" y="0"
                width="{{content.cell}}" height="{{ribbonSize}}" 
                rx="{{content.corners}}" ry="{{content.corners}}"></rect>

          {{ badge(x=0, y=0, size=content.quarterCell, emoji=data.action.icon) }}
          
          {% for item in data.quantities %}
          <text class="ribbon vertical item"  x="0" y="{{content.halfCell+loop.index0*content.halfCell}}">
              {{item.value}}{{item.unit.icon}}
          </text>
          {% endfor %}
        </g>
      {% endif %}
    {% endmacro %}
    
    {% macro hRibbon(name, x, y, data) %}
      {% if data.quantities.length  > 0 %}
        {% set ribbonSize = content.halfCell + data.quantities.length * content.cell*0.7 %}
        {% set step = ribbonSize / (data.quantities.length+1) %}
        <g id="{{name}}" transform="translate({{x -ribbonSize/2}}, {{y}})">
          <rect class="ribbon horizontal background" x="0" y="-{{content.threeQuarterCell}}"
                width="{{ribbonSize}}" height="{{content.cell}}" 
                rx="{{content.corners}}" ry="{{content.corners}}"></rect>
          {{ badge(x=ribbonSize/2, y=-content.threeQuarterCell, size=content.quarterCell, emoji=data.action.icon) }}

          {% for item in data.quantities %}
          <text class="ribbon horizontal item"  x="{{loop.index*step}}" y="-{{content.quarterCell}}">
              {{item.value}}{{item.unit.icon}}
          </text>
          {% endfor %}
        </g>
        {% endif %}
    {% endmacro %}

    <svg xmlns="http://www.w3.org/2000/svg" 
    width="{{ width }}"
    height="{{ height }}" viewBox="0 0 {{ width }} {{ height }}">
      <defs>
        <style type="text/css"><![CDATA[
          
          .badge {
            fill:lightgray;
            stroke:white;
            stroke-width : 0.3%;
          }

          #bleedbox, #trimbox {
            fill:lightgray;
          }

          #trimbox {
            fill:lightgray;
            rx: {{trimbox.corners}};
            ry: {{trimbox.corners}};
            stroke-width : 0;
          }

          #artbox {
          stroke-width : 1;
          fill :white;
          rx : {{content.corners}};
          ry : {{content.corners}};
          }

          text {
            font-family: game-icons, sans-serif;
            font-size:{{content.cell*4}}%;
            fill: black;
            text-anchor: middle;
            alignment-baseline:middle;
          }

          rect.ribbon.background{
            fill : lightgray;
          }

          #header > rect.ribbon.background, #footer > rect.ribbon.background {
            fill : white;
            stroke: lightgray;
            stroke-width: 0.4;
          }

          #title > rect.background {
            fill:white;
          }

          #title > text {
             font-weight:bold;
             font-size:{{content.cell*3}}%;
          }

          text.ribbon.item{
            font-size:{{content.cell*2}}%;
            text-anchor: middle;
            alignment-baseline:middle;
          }

          #emoji{
            font-size:{{content.cell*10}}%;
          }

          #body > rect.background{
            stroke-width: 0;
            stroke: black;
            fill: white;
            filter: url(#fshadow)
          }

          #subtitle > text {
             font-size:{{content.cell}}%;
             fill: gray;
          }

        ]]></style>
        <filter id="fshadow" x="0" y="0" width="200%" height="200%">
          <feOffset result="offOut" in="SourceAlpha" dx="0.5" dy="0.5" />
          <feGaussianBlur result="blurOut" in="offOut" stdDeviation="0.5" />
          <feBlend in="SourceGraphic" in2="blurOut" mode="normal" />
        </filter>
        <filter id="fbw" color-interpolation-filters="sRGB">
          <feColorMatrix type="matrix" values="0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0"/>
          <feComponentTransfer>
            <feFuncR type="discrete" tableValues="0 1"/>
            <feFuncG type="discrete" tableValues="0 1"/>
            <feFuncB type="discrete" tableValues="0 1"/>
          </feComponentTransfer>
        </filter>
        <filter id="fgray" x="0" y="0" width="200%" height="200%">
          <feColorMatrix type="matrix" values="0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0"/>
        </filter>
      </defs>


      <!-- BLEED LAYER-->
      <g id="bleedLayer" transform="translate({{bleedbox.x}}, {{bleedbox.y}})">
        <rect id="bleedbox" x="0" y="0" width="{{bleedbox.width}}" height="{{bleedbox.height}}"/>
      </g>
      
      <!-- TRIM LAYER-->
      <g id="trimLayer" transform="translate({{trimbox.x}}, {{trimbox.y}})">
        <rect id="trimbox" x="0" y="0" width="{{trimbox.width}}" height="{{trimbox.height}}"/>
      </g>

      <!-- ART LAYER-->
      <g id="artLayer" transform="translate({{artbox.x}}, {{artbox.y}})"
       >
        <rect id="artbox"
        x="0" y="0"
        width="{{artbox.width}}" height="{{artbox.height}}"
         />
         <g id="title">
          <rect class="background"
          x="0" y="0"
          width="{{artbox.width}}" height="{{content.cell}}"
          rx="{{content.corners}}" ry="{{content.corners}}"
          /> 
          <text x="{{content.middleX}}" y="{{content.halfCell}}">
              {{'icon' | fromModel}}{{ ['title','name'] | fromModel}}
          </text>
        </g>

        <g id="body" transform="translate({{content.middleX}}, {{content.middleY}})">
          <rect class="background"
          x="-{{content.cell}}" y="-{{content.cell}}"
          width="{{content.cell*2}}" height="{{content.cell*2}}"
          rx="{{content.corners}}" ry="{{content.corners}}"
          />
            <text id="emoji" x="0" y="0">
                {{'icon' | fromModel}}
            </text>
        </g>

        <g id="subtitle" transform="translate({{content.middleX}}, {{content.cell}})">
        <text> {{ 'tags'| fromModel | arrayFromGlossary | arrayOfDisplayName | join(' ') }} </text>
        </g>
        {{ vRibbon("left", content.quarterCell, content.middleY, left) }}
        {{ vRibbon("right", artbox.width-content.quarterCell, content.middleY, right) }}
        {{ hRibbon("footer", content.middleX, artbox.height* 0.8, footer) }}
        {{ hRibbon("header", content.middleX, artbox.height* 0.3, header) }}
        {{ hRibbon("bottom", content.middleX, artbox.height, bottom) }}
      </g>
    </svg>